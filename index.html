<!DOCTYPE html>
<html>
<head>
  <title>나의 대동여지도 - 시간에 따라 흐려지는 발자취</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 100vh; background-color: #222; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([37.5665, 126.9780], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      opacity: 0.2,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let currentLocationMarker = null;
    const visitedPoints = [];

    function onLocationFound(e) {
      const latlng = e.latlng;
      const now = new Date().getTime();

      // 현재 위치 마커 업데이트
      if (currentLocationMarker) {
        currentLocationMarker.setLatLng(latlng);
      } else {
        currentLocationMarker = L.marker(latlng).addTo(map);
      }

      // 지나간 위치 점 추가
      const circle = L.circle(latlng, {
        radius: 5,
        fillColor: 'red',
        color: null,
        fillOpacity: 1.0
      }).addTo(map);

      visitedPoints.push({
        circle: circle,
        timestamp: now
      });
    }

    function onLocationError(e) {
      alert("위치 정보를 가져올 수 없습니다: " + e.message);
    }

    // 흐려지기 효과: 1분마다 모든 점 opacity 업데이트
    function fadeOldPoints() {
      const now = new Date().getTime();
      visitedPoints.forEach(p => {
        const hours = (now - p.timestamp) / (1000 * 60 * 60);
        let opacity;

        if (hours < 1) {
          opacity = 1.0;
        } else if (hours < 24) {
          opacity = 1.0 - ((hours / 24) * 0.8); // 1시간~24시간 사이 점점 흐려짐
        } else {
          opacity = 0.2; // 24시간 이후 고정
        }

        p.circle.setStyle({ fillOpacity: opacity });
      });
    }

    setInterval(fadeOldPoints, 60000); // 1분마다 점 흐려짐

    // 위치 추적 시작
    map.locate({
      setView: true,
      maxZoom: 16,
      watch: true,
      enableHighAccuracy: true
    });

    map.on('locationfound', onLocationFound);
    map.on('locationerror', onLocationError);
  </script>
</body>
</html>
